name: Android Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 JDK 8
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. 升级 Gradle Wrapper (3.5 -> 4.10.1)
    - name: Upgrade Gradle Wrapper
      run: |
        sed -i 's/gradle-.*-all.zip/gradle-4.10.1-all.zip/' gradle/wrapper/gradle-wrapper.properties

    # 4. 重写根目录 build.gradle (配置阿里云镜像 + AGP 3.3.2)
    - name: Overwrite Root build.gradle
      run: |
        cat > build.gradle <<EOF
        buildscript {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url "https://jitpack.io" }
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:3.3.2'
            }
        }
        allprojects {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url "https://jitpack.io" }
            }
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

    # 5. 【修复】重写 ijkplayer-java/build.gradle
    # 依据您提供的内容还原，但修正 SDK 版本为 28，并升级 compile -> implementation
    - name: Overwrite ijkplayer build.gradle
      run: |
        cat > ijkplayer-java/build.gradle <<EOF
        apply plugin: 'com.android.library'

        android {
            // 替换 rootProject.ext 为具体值
            compileSdkVersion 28
            buildToolsVersion "28.0.3"

            defaultConfig {
                minSdkVersion 16
                targetSdkVersion 28
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                }
            }
            
            lintOptions { abortOnError false }

            sourceSets.main {
                jniLibs.srcDirs 'src/main/libs'
                jni.srcDirs = [] // 防止自动生成 Android.mk
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            implementation 'com.google.android.exoplayer:exoplayer:r1.5.7'
        }
        
        // 保留原有的插件加载逻辑 (虽然在CI里可能用不到，但为了保持逻辑一致性)
        ext {
            optionalPlugins = ['tools/gradle-mvn-push.gradle', 'tools/gradle-bintray-upload.gradle'];
        }
        ext.optionalPlugins.each{ value ->
            def plugin_file = new File(rootProject.projectDir, value);
            if (plugin_file.exists()) {
                apply from: plugin_file
            }
        }
        EOF

    # 6. 【修复】重写 app/build.gradle
    # 保持上一轮的正确配置
    - name: Overwrite App build.gradle
      run: |
        cat > app/build.gradle <<EOF
        apply plugin: 'com.android.application'

        android {
            compileSdkVersion 28
            buildToolsVersion "28.0.3"

            defaultConfig {
                minSdkVersion 16
                targetSdkVersion 28
                versionCode 1
                versionName "1.0"
                ndk { abiFilters "armeabi", "armeabi-v7a", "x86" }
            }

            lintOptions { abortOnError false }
            dexOptions { javaMaxHeapSize "4g"; preDexLibraries = false }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                }
                debug { println 'build - debug' }
            }
            
            flavorDimensions "channel"
            productFlavors {
                beta { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE:"beta"] }
                xiaomi { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE:"xiaomi"] }
                m360 { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE:"m360"] }
                wandoujia { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE: "wandoujia"] }
                fir { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE: "fir"] }
                umeng { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE: "umeng"] }
                play { dimension "channel"; manifestPlaceholders = [UMENG_CHANNEL_VALUE: "play"] }
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            testImplementation 'junit:junit:4.12'
            implementation project(':ijkplayer-java')

            // Support Libraries
            implementation 'com.android.support:appcompat-v7:28.0.0'
            implementation 'com.android.support:recyclerview-v7:28.0.0'
            implementation 'com.android.support:design:28.0.0'
            implementation 'com.android.support:support-v4:28.0.0'
            implementation 'com.android.support:cardview-v7:28.0.0'
            implementation 'com.android.support:preference-v7:28.0.0'
            implementation 'com.takisoft.fix:preference-v7:28.0.0.0'
            implementation 'com.github.clans:fab:1.6.4'
            
            // Retrofit & Rx
            implementation 'com.squareup.retrofit:retrofit:2.0.0-beta2'
            implementation 'com.squareup.retrofit:converter-gson:2.0.0-beta2'
            implementation 'com.squareup.retrofit:adapter-rxjava:2.0.0-beta2'
            implementation 'io.reactivex:rxandroid:1.2.0'
            implementation 'io.reactivex:rxjava:1.1.5'

            // UI
            implementation 'com.eightbitlab:blurview:1.0.2'
            implementation 'com.bm.photoview:library:1.4.0'
            implementation 'me.relex:photodraweeview:1.1.2'
            implementation 'com.squareup.picasso:picasso:2.5.2'
            implementation 'com.facebook.fresco:fresco:0.11.0'
            implementation 'com.umeng.analytics:analytics:latest.integration'

            // Butterknife
            implementation 'com.jakewharton:butterknife:8.8.1'
            annotationProcessor 'com.jakewharton:butterknife-compiler:8.8.1'
        }
        EOF

    # 7. 源代码兼容性修复
    - name: Fix Java Source Code
      run: |
        find . -name "*.java" -exec sed -i 's/canvas.save(Canvas.MATRIX_SAVE_FLAG)/canvas.save()/g' {} +

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: app/build/outputs/apk/**/*.apk
        if-no-files-found: warn
